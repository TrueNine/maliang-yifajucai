services:
  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z-cpuv1
    container_name: ${PROJECT_NAME}_minio
    hostname: minio
    restart: always
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_ADMIN_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: '${MINIO_USER}'
      MINIO_ROOT_PASSWORD: '${MINIO_PASSWORD}'
      MINIO_SERVER_URL: "http://${GLOBAL_IP}:9000"
      MINIO_COMPRESS: "on"
      MINIO_COMPRESS_EXTENSIONS: ".pdf,.doc,.docx,.xls,.xlsx,.txt,.log,.csv,.json,.xml,.png,.jpg,.jpeg"
      MINIO_COMPRESS_MIME_TYPES: "application/pdf,application/json,application/xml,image/png,image/jpg,image/jpeg"
    command: server --console-address ':9001' /data
    volumes:
      - ./volumes/minio/data:/data
  api:
    container_name: ${PROJECT_NAME}_java
    hostname: api
    build:
      context: ./ms-playwright
      dockerfile: ./volumes/ms-playwright/Dockerfile
    restart: always
    working_dir: /app
    volumes:
      - ./volumes/java:/app
      - ./.env:/app/.env
      - ./volumes/ms-playwright:/ms-playwright
    command:
      [
        'java',
        '-jar',
        '/app/${PROJECT_NAME}-${PROJECT_VERSION}.jar',
        '--spring.profiles.active=prod',
        '--add-opens java.base/sun.reflect.annotation=ALL-UNNAMED'
      ]
    ports:
      - "${JAVA_PORT:-8080}:8080"
    env_file:
      - ./.env
    environment:
      JVM_VERSION: '${JVM_V}'
      PLAYWRIGHT_VERSION: '${PLAYWRIGHT_V}'
  caddy:
    image: caddy:2.8.4-alpine
    container_name: caddy
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
    volumes:
      - ./volumes/caddy/html:/srv
      - ./volumes/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./volumes/caddy/data:/data
      - ./volumes/caddy/config:/config
    restart: always
    environment:
      TZ: ${TZ:-Asia/Shanghai}
    depends_on:
      - minio
      - postgres
      - api
  redis:
    image: redis:7.4.5-alpine3.21
    container_name: redis
    restart: always
    volumes:
      - ./volumes/redis/redis.conf:/redis.conf
      - ./volumes/redis/data:/data
    command: [
      "redis-server",
      '/redis.conf',
      '--port 6379',
      '--requirepass ${REDIS_PASSWORD}',
    ]
    ports:
      - "${REDIS_PORT:-6379}:6379"
  postgres:
    image: postgres:17.5-alpine3.22
    container_name: postgres
    restart: always
    ports:
      - "${PG_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: '${PG_DB}'
      POSTGRES_USER: '${PG_USER}'
      POSTGRES_PASSWORD: '${PG_PASSWORD}'
    volumes:
      - ./volumes/postgres/data:/var/lib/postgresql/data
