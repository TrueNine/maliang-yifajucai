# Caddy configuration for yifajucai.com
{
  # 全局配置
  email truenine304520@gmail.com

  # 配置多个CA，优先使用ZeroSSL（对国内网络更友好）
  acme_ca https://acme.zerossl.com/v2/DV90

  # 备用CA配置
  acme_ca https://acme-v02.api.letsencrypt.org/directory

  # 设置更长的超时时间
  http_port 80
  https_port 443
}

# HTTP IP访问配置（不重定向到HTTPS）
:80 {
  encode gzip

  # 静态文件服务
  root * /srv/dist

  # 全局匹配器定义
  @static {
    path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
  }
  @html {
    path *.html *.htm
  }

  # 文档路径
  handle_path /docs/* {
    root * /srv/__docs
    try_files {path} /docs/404.html
    header @html Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate"
  }

  # API文档代理
  reverse_proxy /v3/api-docs* api:8080

  # 后端API代理
  handle_path /apis/* {
    reverse_proxy api:8080
  }

  # MinIO对象存储代理
  handle_path /ressources_oss/* {
    reverse_proxy minio:9000
  }

  # 处理SPA路由，所有未匹配的请求返回index.html
  try_files {path} /index.html
  file_server

  # 缓存控制
  header @static Cache-Control "public, max-age=31536000"
  header @html Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate"

  @mjs {
    path *.mjs
  }
  header @mjs Content-Type "application/javascript"
}

# HTTPS域名配置（自动重定向HTTP域名访问到HTTPS）
yifajucai.com {
  # 自动HTTPS和HTTP/2
  encode gzip

  # 静态文件服务
  root * /srv/dist

  # 全局匹配器定义
  @static {
    path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
  }
  @html {
    path *.html *.htm
  }

  # 文档路径
  handle_path /docs/* {
    root * /srv/__docs
    try_files {path} /docs/404.html
    header @html Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate"
  }

  # API文档代理
  reverse_proxy /v3/api-docs* api:8080

  # 后端API代理
  handle_path /apis/* {
    reverse_proxy api:8080
  }

  # MinIO对象存储代理
  handle_path /ressources_oss/* {
    reverse_proxy minio:9000
  }

  # 处理SPA路由，所有未匹配的请求返回index.html
  try_files {path} /index.html
  file_server

  # 缓存控制
  header @static Cache-Control "public, max-age=31536000"
  header @html Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate"

  @mjs {
    path *.mjs
  }
  header @mjs Content-Type "application/javascript"
}
